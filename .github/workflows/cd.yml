name: cd
on:
  push:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    -
      name: Checkout 
      uses: actions/checkout@v2
      
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SERVER_SSH_KEY }}
        known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
        
    - name: Adding Known Hosts
      run: ssh-keyscan -H ${{ secrets.REMOTE_HOST }} >> ~/.ssh/known_hosts
      
    - name: Deploy with rsync
      run: | 
          rsync -avz ./conf.d/ ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:${{ secrets.REMOTE_TARGET }}
          rsync -anz ./nginx.conf ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:/root/api6-docker/example/openresty/nginx/conf
          
    - name: reload config
      run: |
        ssh ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} "
          docker exec example-web1-1 sh -c '/usr/local/openresty/bin/openresty -s reload' -vvv
        "
